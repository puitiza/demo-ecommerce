name: Quality Gate Simple

on:
  pull_request:
    branches: [main]

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Start SonarQube
        run: |
          echo "🚀 Starting SonarQube..."
          docker run -d --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            -e SONARQUBE_ADMIN_PASSWORD="MySecurePoCPass123!" \
            sonarqube:25.9.0.112764-community
          
          echo "⏳ Waiting for SonarQube..."
          sleep 120

      - name: Initialize SonarQube Manually
        run: |
          echo "🏗️ Initializing SonarQube..."
          
          # Wait for API to be ready
          until curl -s http://localhost:9000/api/system/status | grep -q "UP"; do sleep 10; done
          sleep 30
          
          # Change password
          curl -u "admin:admin" -X POST "http://localhost:9000/api/users/change_password" \
            -d "login=admin" -d "previousPassword=admin" -d "password=MySecurePoCPass123!"
          
          # Create project
          curl -u "admin:MySecurePoCPass123!" -X POST "http://localhost:9000/api/projects/create" \
            -d "project=demo-ecommerce" -d "name=Demo E-commerce"
          
          # Generate token
          response=$(curl -s -u "admin:MySecurePoCPass123!" \
            -X POST "http://localhost:9000/api/user_tokens/generate" \
            -d "name=github-actions-token")
          
          token=$(echo "$response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
          mkdir -p imports/sonarqube
          echo "$token" > imports/sonarqube/sonar-token.txt
          
          echo "✅ SonarQube initialized"

      - name: Run Analysis
        run: |
          ./gradlew clean test integrationTest jacocoTestReport sonar

      - name: Check Quality Gate
        run: |
          sleep 30
          TOKEN=$(cat imports/sonarqube/sonar-token.txt)
          curl -s -u "$TOKEN:" \
            "http://localhost:9000/api/qualitygates/project_status?projectKey=demo-ecommerce" \
            | jq -r '.projectStatus.status' | grep -q "OK"

      - name: Cleanup
        if: always()
        run: |
          docker stop sonarqube || true
          docker rm sonarqube || true